version: '3.8'

services:
  gps-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gps-tcp-gateway
    restart: unless-stopped
    
    # Environment variables
    environment:
      - SUPABASE_URL=${SUPABASE_URL:-https://kkmjwmyqakprqdhrlsoz.supabase.co}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrbWp3bXlxYWtwcnFkaHJsc296Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNTc5NDIsImV4cCI6MjA3NjczMzk0Mn0.hcyw7MEssoLz3e09IrJ-aZyepzMsDY98KLnXfjzvuF4}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - GT06_PORT=5023
      - TK103_PORT=5001
      - H02_PORT=5013
      - CONCOX_PORT=5027
    
    # Port mappings
    ports:
      # TCP Ports
      - "5001:5001"   # TK103
      - "5013:5013"   # H02
      - "5023:5023"   # GT06
      - "5027:5027"   # Concox
      # UDP Ports
      - "6001:6001/udp"   # TK103 UDP
      - "6013:6013/udp"   # H02 UDP
      - "6023:6023/udp"   # GT06 UDP
      - "6027:6027/udp"   # Concox UDP
      # Health check
      - "8080:8080"
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Optional: Prometheus metrics exporter
  # Uncomment if you want monitoring
  # metrics-exporter:
  #   image: prom/node-exporter:latest
  #   container_name: gps-gateway-metrics
  #   ports:
  #     - "9100:9100"
  #   depends_on:
  #     - gps-gateway

networks:
  default:
    name: gps-gateway-network
    driver: bridge
